<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Running Map : Run For Your Life</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; background: #000; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* Filtre sombre */
        .leaflet-layer { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }

        /* INTERFACE */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .hud-bar {
            background: rgba(0,0,0,0.8); color: white; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: auto;
        }
        
        .big-text { font-size: 20px; font-weight: bold; display: block; }
        .small-text { font-size: 12px; color: #aaa; }
        .status-silent { color: #00ff00; }
        .status-loud { color: #ff0000; animation: pulse 0.5s infinite; }

        /* BOUTON PAUSE */
        .btn-pause {
            background: transparent; border: 2px solid white; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* ECRANS (Accueil & Pause) */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; pointer-events: all; text-align: center;
        }

        .main-btn {
            color: white; border: none; padding: 15px 30px; margin: 10px;
            font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer;
            width: 80%; max-width: 300px;
        }
        
        .btn-easy { background: #4CAF50; }
        .btn-normal { background: #FF9800; }
        .btn-hard { background: #d32f2f; }
        .resume-btn { background: #2196F3; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="start-screen" class="overlay-screen">
        <h1 style="color: red; font-size: 40px; margin-bottom: 5px;">Running Map : Run For Your Life ! </h1>
        <p style="color: #aaa; margin-bottom: 30px;">recupere les colis et enfuit toi vers l'extraction !</p>
        
        <h3 style="margin-bottom: 10px;">CHOISIS TA DISTANCE</h3>
        
        <button class="main-btn btn-easy" onclick="startGame('easy')">
            PROMENADE (Courte)<br><span style="font-size:12px">Objets proches (~2-3km)</span>
        </button>
        
        <button class="main-btn btn-normal" onclick="startGame('normal')">
            SPORTIF (Moyenne)<br><span style="font-size:12px">Objets dispersés (~6km)</span>
        </button>
        
        <button class="main-btn btn-hard" onclick="startGame('hard')">
            SURVIVANT (Longue)<br><span style="font-size:12px">Expédition lointaine (10km+)</span>
        </button>
    </div>

    <div id="pause-screen" class="overlay-screen" style="display: none;">
        <h1 style="color: white;">PAUSE</h1>
        <p>Le temps et les zombies sont arrêtés.</p>
        <button class="main-btn resume-btn" onclick="togglePause()">REPRENDRE</button>
    </div>

    <div id="ui-layer" style="display: none;">
        <div class="hud-bar">
            <div>
                <span id="speed-display" class="big-text">0.0 km/h</span>
                <span id="noise-display" class="small-text status-silent">SILENCIEUX</span>
            </div>
            <button class="btn-pause" onclick="togglePause()">
                <i class="fas fa-pause"></i>
            </button>
        </div>

        <div class="hud-bar" style="margin-top: auto;">
            <div style="text-align: left;">
                <span class="big-text">SACS</span>
                <span id="score" class="big-text" style="font-size: 24px;">0 / 5</span>
            </div>
            <div style="text-align: right;">
                <span id="timer" class="big-text">00:00</span>
                <span id="lives" class="big-text" style="color: red;">❤❤❤</span>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // --- CONSTANTES ---
        const DETECTION_SILENT = 0.00040; // ~45m
        const DETECTION_LOUD = 0.00150;   // ~150m
        const SPEED_THRESHOLD = 5.0;
        const COLLISION_DIST = 0.000015;  // ~1.5m (Contact réel)

        // VITESSES REALISTES
        const ZOMBIE_SPEED_WALK = 0.0000005; 
        const ZOMBIE_SPEED_RUN = 0.0000030;  

        // VARIABLES GLOBALES
        let GAME_RADIUS = 0.01; // Sera modifié par le choix de difficulté
        let ZOMBIE_COUNT = 150; // Sera adapté à la taille de la carte

        let map, playerMarker, pathLine;
        let pathCoords = [];
        let zombies = [];
        let objectives = [];
        
        let gameRunning = false;
        let isPaused = false;
        let lives = 3;
        let score = 0;
        let startTime;
        let pausedTimeAccumulated = 0;
        let pauseStartTimestamp = 0;

        let playerPos = null;
        let extractionMarker = null;

        // ICONES
        const iconZombie = L.divIcon({ html: '<i class="fas fa-circle" style="color:red; font-size:10px; box-shadow:0 0 5px red;"></i>', className: 'dummy' });
        const iconPlayer = L.divIcon({ html: '<i class="fas fa-circle" style="color:cyan; font-size:14px; border: 2px solid white; border-radius: 50%;"></i>', className: 'dummy' });
        const iconBag = L.divIcon({ html: '<i class="fas fa-shopping-bag" style="color:#00ff00; font-size:24px;"></i>', className: 'dummy' });
        const iconExit = L.divIcon({ html: '<i class="fas fa-flag-checkered" style="color:white; font-size:30px;"></i>', className: 'dummy' });

        // 1. INITIALISATION
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 18);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM contributors', maxZoom: 20
            }).addTo(map);
            pathLine = L.polyline([], {color: 'cyan', weight: 4, opacity: 0.7}).addTo(map);
        }

        // 2. DEMARRAGE AVEC CHOIX DE DIFFICULTÉ
        function startGame(difficulty) {
            
            // Configuration selon le bouton cliqué
            if (difficulty === 'easy') {
                GAME_RADIUS = 0.005; // ~500m de rayon (3km total)
                ZOMBIE_COUNT = 100;  // Moins de zombies car zone petite
            } else if (difficulty === 'normal') {
                GAME_RADIUS = 0.015; // ~1.5km de rayon (6km total)
                ZOMBIE_COUNT = 300;  // Normal
            } else if (difficulty === 'hard') {
                GAME_RADIUS = 0.040; // ~4km de rayon (10km+ total)
                ZOMBIE_COUNT = 800;  // Beaucoup de zombies pour remplir la grande zone
            }

            // Lancement GPS
            if (navigator.geolocation) {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'flex';

                navigator.geolocation.watchPosition(updatePosition, handleError, {
                    enableHighAccuracy: true, maximumAge: 0, timeout: 5000
                });
                
                gameRunning = true;
                startTime = Date.now();
                
                setInterval(gameLoop, 100); 
                setInterval(updateTimer, 1000);
            } else {
                alert("GPS requis pour jouer !");
            }
        }

        function togglePause() {
            if (!gameRunning) return;
            isPaused = !isPaused;
            const pauseScreen = document.getElementById('pause-screen');

            if (isPaused) {
                pauseScreen.style.display = 'flex';
                pauseStartTimestamp = Date.now();
            } else {
                pauseScreen.style.display = 'none';
                pausedTimeAccumulated += (Date.now() - pauseStartTimestamp);
            }
        }

        function updatePosition(position) {
            if (isPaused) return;

            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const speed = position.coords.speed ? (position.coords.speed * 3.6) : 0;

            playerPos = { lat, lng };

            if (!playerMarker) {
                map.setView([lat, lng], 19);
                playerMarker = L.marker([lat, lng], {icon: iconPlayer}).addTo(map);
                spawnGameElements(lat, lng);
            } else {
                playerMarker.setLatLng([lat, lng]);
                map.setView([lat, lng]);
            }

            pathCoords.push([lat, lng]);
            pathLine.setLatLngs(pathCoords);

            // UI Vitesse
            document.getElementById('speed-display').innerText = speed.toFixed(1) + " km/h";
            const noiseLabel = document.getElementById('noise-display');
            
            if (speed > SPEED_THRESHOLD) {
                noiseLabel.innerText = "BRUYANT !!!";
                noiseLabel.className = "small-text status-loud";
                playerMarker.detectionRadius = DETECTION_LOUD; 
            } else {
                noiseLabel.innerText = "SILENCIEUX";
                noiseLabel.className = "small-text status-silent";
                playerMarker.detectionRadius = DETECTION_SILENT;
            }
        }

        function spawnGameElements(lat, lng) {
            // ZOMBIES (Répartis dans la zone choisie)
            for(let i=0; i<ZOMBIE_COUNT; i++) {
                const zLat = lat + (Math.random() - 0.5) * (GAME_RADIUS * 2);
                const zLng = lng + (Math.random() - 0.5) * (GAME_RADIUS * 2);
                const marker = L.marker([zLat, zLng], {icon: iconZombie}).addTo(map);
                
                zombies.push({
                    marker: marker,
                    state: 'WANDERING',
                    spawnPoint: {lat: zLat, lng: zLng},
                    wanderTarget: null,
                    speedFactor: 0.8 + Math.random() * 0.4
                });
            }

            // OBJECTIFS (Dispersés selon la difficulté)
            for(let i=0; i<5; i++) {
                // On place les sacs entre 50% et 100% du rayon max pour forcer à marcher
                const angle = Math.random() * Math.PI * 2;
                // Distance aléatoire mais pas trop près
                const dist = (GAME_RADIUS * 0.5) + (Math.random() * (GAME_RADIUS * 0.5)); 
                
                const oLat = lat + Math.cos(angle) * dist;
                const oLng = lng + Math.sin(angle) * dist;
                
                const marker = L.marker([oLat, oLng], {icon: iconBag}).addTo(map);
                objectives.push(marker);
            }
        }

        function gameLoop() {
            if (!playerPos || lives <= 0 || isPaused) return;

            zombies.forEach(zombie => {
                const zPos = zombie.marker.getLatLng();
                const dist = Math.sqrt(Math.pow(zPos.lat - playerPos.lat, 2) + Math.pow(zPos.lng - playerPos.lng, 2));

                // IA
                if (zombie.state === 'WANDERING') {
                    if (dist < playerMarker.detectionRadius) {
                        zombie.state = 'CHASING';
                        zombie.wanderTarget = null;
                    } else {
                        if (!zombie.wanderTarget) {
                            zombie.wanderTarget = {
                                lat: zombie.spawnPoint.lat + (Math.random() - 0.5) * 0.002,
                                lng: zombie.spawnPoint.lng + (Math.random() - 0.5) * 0.002
                            };
                        }
                        moveToTarget(zombie, zombie.wanderTarget, ZOMBIE_SPEED_WALK * zombie.speedFactor);
                        const dw = Math.sqrt(Math.pow(zPos.lat - zombie.wanderTarget.lat, 2) + Math.pow(zPos.lng - zombie.wanderTarget.lng, 2));
                        if (dw < 0.00005) zombie.wanderTarget = null;
                    }
                }

                if (zombie.state === 'CHASING') {
                    if (dist > DETECTION_LOUD * 1.2) {
                        zombie.state = 'WANDERING';
                    } else {
                        let runSpeed = ZOMBIE_SPEED_RUN * zombie.speedFactor;
                        if (playerMarker.detectionRadius === DETECTION_LOUD) runSpeed *= 1.2;

                        moveToTarget(zombie, playerPos, runSpeed);

                        if (dist < COLLISION_DIST) { 
                            lives--;
                            updateLives();
                            const angle = Math.atan2(zPos.lng - playerPos.lng, zPos.lat - playerPos.lat);
                            zombie.marker.setLatLng([zPos.lat + Math.cos(angle)*0.0005, zPos.lng + Math.sin(angle)*0.0005]);
                            zombie.state = 'WANDERING'; 
                            if(navigator.vibrate) navigator.vibrate(200);
                            alert("AIE ! Contact !");
                        }
                    }
                }
            });

            checkObjectives();
            checkExtraction();
        }

        function moveToTarget(zombie, target, speed) {
            const zPos = zombie.marker.getLatLng();
            const angle = Math.atan2(target.lng - zPos.lng, target.lat - zPos.lat);
            const newLat = zPos.lat + Math.cos(angle) * speed;
            const newLng = zPos.lng + Math.sin(angle) * speed;
            zombie.marker.setLatLng([newLat, newLng]);
        }

        function checkObjectives() {
            for (let i = objectives.length - 1; i >= 0; i--) {
                const oPos = objectives[i].getLatLng();
                const dist = Math.sqrt(Math.pow(oPos.lat - playerPos.lat, 2) + Math.pow(oPos.lng - playerPos.lng, 2));
                if (dist < 0.00015) { 
                    map.removeLayer(objectives[i]);
                    objectives.splice(i, 1);
                    score++;
                    document.getElementById('score').innerText = score + " / 5";
                    if (score === 5) spawnExtraction();
                }
            }
        }

        function checkExtraction() {
            if (extractionMarker) {
                const ePos = extractionMarker.getLatLng();
                const dist = Math.sqrt(Math.pow(ePos.lat - playerPos.lat, 2) + Math.pow(ePos.lng - playerPos.lng, 2));
                if (dist < 0.00015) {
                    alert("VICTOIRE !");
                    location.reload();
                }
            }
        }

        function spawnExtraction() {
            // L'extraction spawn à la limite de la zone de jeu pour forcer à finir
            const angle = Math.random() * Math.PI * 2;
            const dist = GAME_RADIUS * 0.9; 
            const lat = playerPos.lat + Math.cos(angle) * dist;
            const lng = playerPos.lng + Math.sin(angle) * dist;
            
            extractionMarker = L.marker([lat, lng], {icon: iconExit}).addTo(map);
            alert("EXTRACTION ! Regarde ta carte !");
        }

        function updateLives() {
            let hearts = ""; for(let i=0; i<lives; i++) hearts += "❤";
            document.getElementById('lives').innerText = hearts;
            if(lives <= 0) { alert("MORT..."); location.reload(); }
        }

        function updateTimer() {
            if(!gameRunning || isPaused) return;
            const totalElapsed = Date.now() - startTime - pausedTimeAccumulated;
            const diff = Math.floor(totalElapsed / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function handleError(err) { alert("Erreur GPS: " + err.message); }

        initMap();
    </script>
</body>
</html>
