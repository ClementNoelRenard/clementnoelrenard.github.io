<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zombie Run Web</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; background: #000; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* FILTRE SOMBRE POUR AMBIANCE ZOMBIE */
        .leaflet-layer { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }

        /* INTERFACE (HUD) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .hud-bar {
            background: rgba(0,0,0,0.8); color: white; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .stat-box { text-align: center; }
        .big-text { font-size: 20px; font-weight: bold; display: block; }
        .small-text { font-size: 12px; color: #aaa; }
        
        .status-silent { color: #00ff00; }
        .status-loud { color: #ff0000; animation: pulse 0.5s infinite; }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; pointer-events: all;
        }

        button {
            background: #d32f2f; color: white; border: none; padding: 15px 30px;
            font-size: 20px; font-weight: bold; border-radius: 5px; margin-top: 20px;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color: red; font-size: 40px;">ZOMBIE RUN</h1>
        <p>Marche doucement (< 5km/h) pour être invisible.</p>
        <p>Récupère 5 sacs.</p>
        <button onclick="startGame()">SURVIVRE</button>
    </div>

    <div id="ui-layer" style="display: none;">
        <div class="hud-bar" style="align-items: flex-start;">
            <div>
                <span id="speed-display" class="big-text">0.0 km/h</span>
                <span id="noise-display" class="small-text status-silent">SILENCIEUX</span>
            </div>
            <div style="text-align: right;">
                <span id="timer" class="big-text">00:00</span>
                <span id="lives" class="big-text" style="color: red;">❤❤❤</span>
            </div>
        </div>

        <div class="hud-bar">
            <span class="big-text">OBJECTIFS</span>
            <span id="score" class="big-text" style="font-size: 30px;">0 / 5</span>
        </div>
    </div>

    <div id="map"></div>

<script>
        // CONFIGURATION
        const ZOMBIE_COUNT = 200; // Nombre de zombies
        const GAME_RADIUS = 0.02; // Rayon de spawn (~2km)
        const DETECTION_SILENT = 0.00015; // 15m (Invisible)
        const DETECTION_LOUD = 0.00150; // 150m (Bruyant)
        const SPEED_THRESHOLD = 5.0; // Seuil de vitesse (km/h)

        // VARIABLES
        let map, playerMarker;
        let pathLine; // LA LIGNE DU TRACÉ
        let pathCoords = []; // L'HISTORIQUE DES POSITIONS

        let zombies = [];
        let objectives = [];
        let gameRunning = false;
        let lives = 3;
        let score = 0;
        let startTime;
        let playerPos = null;
        let extractionMarker = null;

        // ICONS (Dessins simplifiés)
        const iconZombie = L.divIcon({ html: '<i class="fas fa-circle" style="color:red; font-size:10px; box-shadow:0 0 5px red;"></i>', className: 'dummy' });
        const iconPlayer = L.divIcon({ html: '<i class="fas fa-circle" style="color:cyan; font-size:14px; border: 2px solid white; border-radius: 50%;"></i>', className: 'dummy' });
        const iconBag = L.divIcon({ html: '<i class="fas fa-shopping-bag" style="color:#00ff00; font-size:20px;"></i>', className: 'dummy' });
        const iconExit = L.divIcon({ html: '<i class="fas fa-flag-checkered" style="color:white; font-size:30px;"></i>', className: 'dummy' });

        // 1. INITIALISATION DE LA CARTE
        function initMap() {
            // On centre sur Paris par défaut, mais le GPS changera ça tout de suite
            map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 18);
            
            // Fond de carte sombre
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM contributors',
                maxZoom: 20
            }).addTo(map);

            // Création de la ligne bleue (vide pour l'instant)
            pathLine = L.polyline([], {color: 'cyan', weight: 4, opacity: 0.7}).addTo(map);
        }

        // 2. LANCER LE JEU
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            if (navigator.geolocation) {
                // Demande le GPS haute précision
                navigator.geolocation.watchPosition(updatePosition, handleError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
                
                gameRunning = true;
                startTime = Date.now();
                
                // Boucles de jeu
                setInterval(gameLoop, 200); // Mise à jour IA (5 fois par seconde)
                setInterval(updateTimer, 1000); // Chronomètre
            } else {
                alert("Erreur : Ton navigateur ne supporte pas le GPS.");
            }
        }

        // 3. MISE A JOUR GPS DU JOUEUR
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            // Calcul vitesse (si dispo, sinon 0)
            const speed = position.coords.speed ? (position.coords.speed * 3.6) : 0; 

            playerPos = { lat, lng };

            // A. Premier lancement : on crée le joueur et les zombies
            if (!playerMarker) {
                map.setView([lat, lng], 19);
                playerMarker = L.marker([lat, lng], {icon: iconPlayer}).addTo(map);
                spawnGameElements(lat, lng);
            } else {
                // B. Mise à jour position
                playerMarker.setLatLng([lat, lng]);
                map.setView([lat, lng]); // La caméra suit le joueur
            }

            // C. Mise à jour du TRACÉ (Path)
            pathCoords.push([lat, lng]);
            pathLine.setLatLngs(pathCoords);

            // D. Mise à jour Interface (Vitesse et Bruit)
            document.getElementById('speed-display').innerText = speed.toFixed(1) + " km/h";
            const noiseLabel = document.getElementById('noise-display');
            
            if (speed > SPEED_THRESHOLD) {
                noiseLabel.innerText = "BRUYANT !!!";
                noiseLabel.className = "small-text status-loud";
                // On stocke le rayon de détection dans l'objet joueur pour que les zombies le lisent
                playerMarker.detectionRadius = DETECTION_LOUD; 
            } else {
                noiseLabel.innerText = "SILENCIEUX";
                noiseLabel.className = "small-text status-silent";
                playerMarker.detectionRadius = DETECTION_SILENT;
            }
        }

        // 4. CRÉATION DES ZOMBIES ET OBJECTIFS
        function spawnGameElements(lat, lng) {
            // Créer les Zombies autour
            for(let i=0; i<ZOMBIE_COUNT; i++) {
                const zLat = lat + (Math.random() - 0.5) * GAME_RADIUS;
                const zLng = lng + (Math.random() - 0.5) * GAME_RADIUS;
                
                const marker = L.marker([zLat, zLng], {icon: iconZombie}).addTo(map);
                
                zombies.push({
                    marker: marker,
                    state: 'WANDERING',
                    // Vitesse très lente de base (en degrés lat/lng)
                    speed: 0.00003 + Math.random() * 0.00002 
                });
            }

            // Créer les 5 sacs
            for(let i=0; i<5; i++) {
                // Rayon plus court pour les objectifs (~500m)
                const oLat = lat + (Math.random() - 0.5) * 0.01; 
                const oLng = lng + (Math.random() - 0.5) * 0.01;
                const marker = L.marker([oLat, oLng], {icon: iconBag}).addTo(map);
                objectives.push(marker);
            }
        }

        // 5. BOUCLE D'INTELLIGENCE ARTIFICIELLE
        function gameLoop() {
            if (!playerPos || lives <= 0) return;

            // --- ZOMBIES ---
            zombies.forEach(zombie => {
                const zPos = zombie.marker.getLatLng();
                // Distance simple (Théorème de Pythagore)
                const dist = Math.sqrt(Math.pow(zPos.lat - playerPos.lat, 2) + Math.pow(zPos.lng - playerPos.lng, 2));

                // A. Détection
                if (zombie.state === 'WANDERING') {
                    // Si le joueur est dans le rayon (qui change selon sa vitesse)
                    if (dist < playerMarker.detectionRadius) {
                        zombie.state = 'CHASING';
                    }
                }

                // B. Mouvement
                if (zombie.state === 'CHASING') {
                    // Si le joueur est parti trop loin (1.5x le rayon bruyant), on abandonne
                    if (dist > DETECTION_LOUD * 1.5) {
                        zombie.state = 'WANDERING';
                    } else {
                        // On avance vers le joueur
                        // Calcul de l'angle
                        const angle = Math.atan2(playerPos.lng - zPos.lng, playerPos.lat - zPos.lat);
                        
                        // Si on court, le zombie accélère un peu (x1.5)
                        let currentSpeed = zombie.speed;
                        if(playerMarker.detectionRadius === DETECTION_LOUD) currentSpeed *= 1.5;

                        const newLat = zPos.lat + Math.cos(angle) * currentSpeed; // Cosinus pour Lat (Axe Y)
                        const newLng = zPos.lng + Math.sin(angle) * currentSpeed; // Sinus pour Lng (Axe X)
                        
                        zombie.marker.setLatLng([newLat, newLng]);

                        // C. Collision (Morsure)
                        if (dist < 0.00008) { // ~8 mètres
                            lives--;
                            updateLives();
                            // On repousse le zombie en arrière pour pas mourir 2 fois de suite
                            zombie.marker.setLatLng([zPos.lat - 0.001, zPos.lng - 0.001]);
                            zombie.state = 'WANDERING';
                            alert("AIE ! Un zombie t'a mordu !");
                        }
                    }
                }
            });

            // --- OBJECTIFS ---
            for (let i = objectives.length - 1; i >= 0; i--) {
                const oPos = objectives[i].getLatLng();
                const dist = Math.sqrt(Math.pow(oPos.lat - playerPos.lat, 2) + Math.pow(oPos.lng - playerPos.lng, 2));
                
                if (dist < 0.0002) { // ~20 mètres
                    map.removeLayer(objectives[i]);
                    objectives.splice(i, 1);
                    score++;
                    document.getElementById('score').innerText = score + " / 5";
                    
                    if (score === 5) spawnExtraction();
                }
            }

            // --- EXTRACTION ---
            if (extractionMarker) {
                const ePos = extractionMarker.getLatLng();
                const dist = Math.sqrt(Math.pow(ePos.lat - playerPos.lat, 2) + Math.pow(ePos.lng - playerPos.lng, 2));
                if (dist < 0.0002) {
                    alert("VICTOIRE ! Tu as survécu en " + document.getElementById('timer').innerText);
                    gameRunning = false;
                    location.reload();
                }
            }
        }

        function spawnExtraction() {
            // Spawn à environ 500m-1km
            const lat = playerPos.lat + (Math.random() - 0.5) * 0.015;
            const lng = playerPos.lng + (Math.random() - 0.5) * 0.015;
            extractionMarker = L.marker([lat, lng], {icon: iconExit}).addTo(map);
            alert("EXTRACTION DISPONIBLE ! Trouve le drapeau blanc !");
        }

        function updateLives() {
            let hearts = "";
            for(let i=0; i<lives; i++) hearts += "❤";
            document.getElementById('lives').innerText = hearts;
            if(lives <= 0) {
                alert("GAME OVER... Tu es devenu un zombie.");
                location.reload();
            }
        }

        function updateTimer() {
            if(!gameRunning) return;
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function handleError(err) {
            console.warn('Erreur GPS: ' + err.message);
            alert("Active ton GPS pour jouer !");
        }

        // Démarrage de la carte au chargement de la page
        initMap();

    </script>
</body>
</html>